{"version":3,"file":"hashindex.js","sources":["../src/common.js","../src/indexes/hashindex.js"],"sourcesContent":["export function oneOrMany(items) {\r\n    if (!items) {\r\n        return [];\r\n    } else if (items instanceof Map) {\r\n        return Array.from(items.values());\r\n    } else if (!Array.isArray(items)) {\r\n        return [items];\r\n    } else {\r\n        return items;\r\n    }\r\n}\r\n\r\nexport function lt(comparer, a, b) {\r\n    return comparer(a, b) === -1;\r\n}\r\n\r\nexport function gt(comparer, a, b) {\r\n    return comparer(a, b) === 1;\r\n}\r\n\r\nexport function eq(comparer, a, b) {\r\n    return comparer(a, b) === 0;\r\n}\r\n\r\nexport function defaultComparer(a, b) {\r\n    return a > b ? 1 : a < b ? -1 : 0;\r\n}\r\n\r\nexport function intersect(arrays) {\r\n    const ordered = (arrays.length===1\r\n        ? arrays : \r\n        arrays.sort((a1,a2) => a1.length - a2.length));\r\n    const shortest = ordered[0],\r\n        set = new Set(), \r\n        result = [];\r\n\r\n    for (let i=0; i < shortest.length; i++) {\r\n        const item = shortest[i];\r\n        let every = true; // don't use ordered.every ... it is slow\r\n        for(let j=1;j<ordered.length;j++) {\r\n            if(ordered[j].includes(item)) continue;\r\n            every = false;\r\n            break;\r\n        }\r\n        // ignore if not in every other array, or if already captured\r\n        if(!every || set.has(item)) continue;\r\n        // otherwise, add to bookeeping set and the result\r\n        set.add(item);\r\n        result[result.length] = item;\r\n    }\r\n    return result;\r\n}\r\n\r\nexport function extract(map, keys) {\r\n    const r = [];\r\n    keys.forEach((key) => {\r\n        if (map.has(key)) {\r\n            r.push(map.get(key));\r\n        }\r\n    });    \r\n    return r;\r\n}","import * as mem from '../common';\r\n\r\nclass HashIndex {\r\n    constructor (name, itemFn, keyFn, comparer) {\r\n        this.index = new Map([]);\r\n        this.name = name;\r\n        this.itemFn = itemFn;\r\n        this.keyFn = keyFn;\r\n        this.comparer = comparer || mem.defaultComparer;\r\n    }\r\n    \r\n    static build(name, itemFn, keyFn, items, comparer) {\r\n        let bin = new HashIndex(name, itemFn, keyFn, comparer);\r\n        bin.add(items);\r\n        return bin;\r\n    }\r\n\r\n    get keys() {\r\n        return Array.from(this.index.keys());\r\n    }\r\n\r\n    clear() {\r\n        this.index = new Map([]);\r\n    }\r\n\r\n    getOne(key) {\r\n        return this.index.get(key);\r\n    }\r\n\r\n    get(keys) {\r\n        keys = mem.oneOrMany(keys);\r\n        if (keys.length === 1) {\r\n            return this.getOne(keys[0]);\r\n        }\r\n        let data = keys.map(m => getOne(m));\r\n        return [].concat.apply([], data);\r\n    }\r\n\r\n    remove(items) {\r\n        items = mem.oneOrMany(items);\r\n        items.forEach(item => {\r\n            this.removeOne(item);\r\n        });\r\n    }\r\n\r\n    removeOne(item) {\r\n        const key = this.keyFn(item);\r\n        if (this.index.has(key)) {\r\n            const col = this.index.get(key);\r\n            const it = this.itemFn(item);\r\n            const i = col.indexOf(it);\r\n            if (i > -1) {\r\n                col.splice(i, 1);\r\n            }\r\n            if (col.length === 0) {\r\n                this.index.delete(key);\r\n            }\r\n        }\r\n    }\r\n\r\n    add(items) {\r\n        items = mem.oneOrMany(items);\r\n        items.forEach(item => {\r\n            this.addOne(item);\r\n        });\r\n    }\r\n\r\n    addOne(item) {\r\n        const key = this.keyFn(item);\r\n        const it = this.itemFn(item);\r\n        if (it && key) {\r\n            if (this.index.has(key)) {\r\n                this.index.get(key).push(it);\r\n            } else {\r\n                this.index.set(key, [it]);\r\n            }\r\n        }\r\n    }\r\n\r\n    update(item, olditem) {\r\n        this.removeOne(olditem);\r\n        this.addOne(item);\r\n    }\r\n}\r\n\r\nexport default HashIndex;"],"names":["mem.defaultComparer","let","mem.oneOrMany","this","const"],"mappings":"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"}